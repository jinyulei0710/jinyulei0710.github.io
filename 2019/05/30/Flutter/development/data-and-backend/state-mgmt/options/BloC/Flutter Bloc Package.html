<hr>
<p>layout: post<br>title:  â€œ(è¯‘)Flutter blocåŒ…â€<br>date:   2019-04-22 14:16:17 +0800<br>categories: </p>
<ul>
<li>Flutter å¼€å‘<br>tags:<ul>
<li>çŠ¶æ€ç®¡ç† </li>
<li>BLoC</li>
</ul>
</li>
</ul>
<hr>
<p><a href="https://medium.com/flutter-community/flutter-bloc-package-295b53e95c5c">åŸæ–‡é“¾æ¥</a></p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*lP-1aF6Rg8jo459f87l3zg.png" alt></p>
<p>åœ¨ä½¿ç”¨Flutterä¸€æ®µæ—¶é—´ä¹‹åï¼Œæˆ‘å†³å®šåˆ›é€ ä¸€ä¸ªåŒ…å¸®å¿™æˆ‘ç»å¸¸ä½¿ç”¨çš„ä¸œè¥¿â€”BLoCæ¨¡å¼åšä¸€äº›äº‹æƒ…ã€‚</p>
<!--more-->


<p>å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰BLoCæ¨¡å¼çš„äººæ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒæœ‰åŠ©äºå°†è¡¨ç¤ºå±‚ä¸ä¸šåŠ¡é€»è¾‘åˆ†å¼€ã€‚ä½ ä»<a href="https://www.youtube.com/watch?v=fahC3ky_zW0">è¿™é‡Œ</a>èƒ½å¤Ÿäº†è§£æ›´å¤šã€‚</p>
<p>è™½ç„¶ä½¿ç”¨BLoCæ¨¡å¼å¯èƒ½ä¼šå› ä¸ºè®¾ç½®ä»¥åŠå¯¹<code>Streams</code>å’Œ<code>Reactive Programming</code>çš„ç†è§£è€Œå…·æœ‰æŒ‘æˆ˜æ€§ï¼Œä½†å®ƒçš„æ ¸å¿ƒBLoCæ˜¯éå¸¸ç®€å•çš„ï¼š</p>
<p>BLoCå°†äº‹ä»¶æµä½œä¸ºè¾“å…¥ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºçŠ¶æ€æµä½œä¸ºè¾“å‡ºã€‚</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*_EgLk67LpREOEMCSIhc_4Q.png" alt></p>
<p>æˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨blocåŒ…çš„å¸®åŠ©ä¸‹ä½¿ç”¨è¿™ç§å¼ºå¤§çš„è®¾è®¡æ¨¡å¼ã€‚</p>
<p>è¯¥è½¯ä»¶åŒ…æŠ½è±¡äº†BLoCæ¨¡å¼çš„å“åº”å¼æ–¹é¢ï¼Œå…è®¸å¼€å‘äººå‘˜ä¸“æ³¨äºå°†äº‹ä»¶è½¬æ¢ä¸ºçŠ¶æ€ã€‚</p>
<p>è®©æˆ‘ä»¬ä»å®šä¹‰è¿™äº›æœ¯è¯­å¼€å§‹ã€‚</p>
<h2 id="è¯æ±‡è¡¨"><a href="#è¯æ±‡è¡¨" class="headerlink" title="è¯æ±‡è¡¨"></a>è¯æ±‡è¡¨</h2><p>äº‹ä»¶(<code>Events</code>)æ˜¯BLoCçš„è¾“å…¥ã€‚å®ƒä»¬é€šå¸¸æ˜¯UIäº‹ä»¶ï¼Œä¾‹å¦‚æŒ‰é’®æŒ‰ä¸‹ã€‚äº‹ä»¶(<code>Events</code>)è¢«å‘é€(<code>dispatched</code>)å¹¶è½¬æ¢ä¸ºçŠ¶æ€(<code>States</code>)ã€‚</p>
<p>çŠ¶æ€(<code>State</code>)æ˜¯BLoCçš„äº§ç‰©ã€‚è¡¨ç¤ºç»„ä»¶å¯ä»¥ç›‘å¬çŠ¶æ€æµå¹¶æ ¹æ®ç»™å®šçŠ¶æ€å¯¹å…¶è‡ªèº«çš„éƒ¨åˆ†è¿›è¡Œé‡ç»˜(æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<code>BlocBuilder</code>)ã€‚</p>
<p>è½¬æ¢(<code>Transitions</code>)å‘ç”Ÿåœ¨mapEventToStateè¢«è°ƒç”¨ä¹‹åï¼Œå½“äº‹ä»¶è¢«å‘é€ä¹‹åï¼Œä½†åœ¨blocçŠ¶æ€è¢«ä¿®æ”¹ä¹‹å‰ã€‚ä¸€ä¸ªè½¬æ¢(<code>Transition</code>)ç”±å½“å‰çŠ¶æ€(<code>currentState</code>)ï¼Œå·²åˆ†é€çš„äº‹ä»¶(<code>event</code>)å’Œä¸‹ä¸ªçŠ¶æ€(<code>nextState</code>)ç»„æˆã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬äº†è§£äº‹ä»¶å’ŒçŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹Bloc APIäº†ã€‚</p>
<h2 id="Bloc-API"><a href="#Bloc-API" class="headerlink" title="Bloc API"></a>Bloc API</h2><p>mapEventToStateæ˜¯ä¸€ä¸ªç±»åœ¨æ‰©å±•Blocæ—¶å¿…é¡»å®ç°çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•å°†ä¼ å…¥äº‹ä»¶ä½œä¸ºå‚æ•°ã€‚åªè¦æœ‰ä¸€ä¸ªäº‹ä»¶è¢«è¡¨ç¤ºå±‚å‘é€(<code>dispatched</code>)ï¼Œå°±ä¼šè°ƒç”¨<code>mapEventToState</code>ã€‚ <code>mapEventToState</code>å¿…é¡»å°†è¯¥äº‹ä»¶è½¬æ¢ä¸ºæ–°çŠ¶æ€ï¼Œå¹¶<code>Stream</code>çš„å½¢å¼è¿”å›æ–°çŠ¶æ€,è€Œè¿™ä¸ªæ–°çŠ¶æ€ä¼šè¢«è¡¨ç¤ºå±‚ä½¿ç”¨ã€‚</p>
<p><code>dispatch</code>æ˜¯ä¸€ä¸ªæ¥æ”¶äº‹ä»¶å¹¶è§¦å‘<code>mapEventToState</code>çš„æ–¹æ³•ã€‚å¯ä»¥ä»è¡¨ç¤ºå±‚æˆ–ä»Blocå†…éƒ¨è°ƒç”¨dispatchï¼ˆå‚è§ç¤ºä¾‹ï¼‰å¹¶å‘Blocé€šçŸ¥æ–°äº‹ä»¶æ¥äº†ã€‚</p>
<p><code>initialState</code>æ˜¯ä»»ä½•äº‹ä»¶éƒ½æ²¡æœ‰è¢«å¤„ç†ä¹‹å‰çš„çŠ¶æ€ï¼ˆåœ¨è°ƒç”¨<code>mapEventToState</code>ä¹‹å‰ï¼‰ã€‚initialStateæ˜¯ä¸€ä¸ªå¯é€‰çš„getterã€‚å¦‚æœæœªå®ç°ï¼Œåˆ™initialStateå°†ä¸ºnullã€‚</p>
<p><code>transform</code>æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åœ¨è°ƒç”¨<code>mapEventToState</code>ä¹‹å‰é‡å†™Stream<event>ã€‚è¿™å…¶ä¸­å…è®¸ä½¿ç”¨distinct()å’Œdebounce()ä¹‹ç±»çš„æ“ä½œã€‚</event></p>
<p><code>onTransition</code>æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åœ¨å‘ç”Ÿè½¬æ¢æ—¶è¦†ç›–å¯¹å…¶åŠ ä»¥å¤„ç†ã€‚è½¬æ¢(<code>Transition</code>)å‘ç”Ÿåœ¨æ–°çš„äº‹ä»¶(<code>event</code>)è¢«å‘é€ä»¥åŠ<code>mapEventToState</code>è¢«è°ƒç”¨çš„æ—¶å€™ã€‚<code>onTransition</code>åœ¨blocçš„çŠ¶æ€è¢«æ›´æ–°ä¹‹å‰è¢«è°ƒç”¨ã€‚è¿™æ˜¯æ·»åŠ blocç‰¹æœ‰çš„æ—¥å¿—è®°å½•/åˆ†æçš„å¥½åœ°æ–¹ã€‚</p>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨blocï¼</p>
<pre><code class="dart"><span class="keyword">enum</span> CounterEvent { increment, decrement }

<span class="class"><span class="keyword">class</span> <span class="title">CounterBloc</span> <span class="keyword">extends</span> <span class="title">Bloc</span>&lt;<span class="title">CounterEvent</span>, <span class="title">int</span>&gt; </span>{
  <span class="meta">@override</span>
  <span class="built_in">int</span> <span class="keyword">get</span> initialState =&gt; <span class="number">0</span>;

  <span class="meta">@override</span>
  Stream&lt;<span class="built_in">int</span>&gt; mapEventToState(CounterEvent event) <span class="keyword">async</span>* {
    <span class="keyword">switch</span> (event) {
      <span class="keyword">case</span> CounterEvent.decrement:
        <span class="keyword">yield</span> currentState - <span class="number">1</span>;
        <span class="keyword">break</span>;
      <span class="keyword">case</span> CounterEvent.increment:
        <span class="keyword">yield</span> currentState + <span class="number">1</span>;
        <span class="keyword">break</span>;
    }
  }
}</code></pre>
<p>ä¸ºäº†åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨blocï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ï¼š</p>
<ul>
<li>å®šä¹‰æˆ‘ä»¬çš„äº‹ä»¶å’ŒçŠ¶æ€</li>
<li>æ‰©å±•BloC</li>
<li>è¦†ç›–<code>initialState</code>å’Œ<code>mapEventToState</code>ã€‚</li>
</ul>
<p>åœ¨è¿™ç§æƒ…å†µä¸­ï¼Œæˆ‘ä»¬çš„äº‹ä»¶æ˜¯<code>CounterEvents</code>ï¼Œæˆ‘ä»¬çš„çŠ¶æ€æ˜¯æ•´æ•°ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬çš„<code>CounterBloc</code>å°†<code>CounterEvents</code>è½¬æ¢ä¸ºæ•´æ•°ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åƒè¿™æ ·è°ƒç”¨<code>dispatch</code>æ–¹æ³•æ¥é€šçŸ¥CounterBlocå‘å‡ºäº‹ä»¶ï¼š</p>
<pre><code class="dart"><span class="keyword">void</span> main() {
  <span class="keyword">final</span> counterBloc = CounterBloc();

  counterBloc.dispatch(CounterEvent.increment);
  counterBloc.dispatch(CounterEvent.decrement);
}</code></pre>
<p>ä¸ºäº†è§‚å¯ŸçŠ¶æ€å˜åŒ–(<code>Transitions</code>ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è¦†ç›–<code>onTransition</code>ã€‚</p>
<pre><code class="dart"><span class="keyword">enum</span> CounterEvent { increment, decrement }

<span class="class"><span class="keyword">class</span> <span class="title">CounterBloc</span> <span class="keyword">extends</span> <span class="title">Bloc</span>&lt;<span class="title">CounterEvent</span>, <span class="title">int</span>&gt; </span>{
  <span class="meta">@override</span>
  <span class="built_in">int</span> <span class="keyword">get</span> initialState =&gt; <span class="number">0</span>;

  <span class="meta">@override</span>
  <span class="keyword">void</span> onTransition(Transition&lt;CounterEvent, <span class="built_in">int</span>&gt; transition) {
    <span class="built_in">print</span>(transition);
  }

  <span class="meta">@override</span>
  Stream&lt;<span class="built_in">int</span>&gt; mapEventToState(CounterEvent event) <span class="keyword">async</span>* {
    <span class="keyword">switch</span> (event) {
      <span class="keyword">case</span> CounterEvent.decrement:
        <span class="keyword">yield</span> currentState - <span class="number">1</span>;
        <span class="keyword">break</span>;
      <span class="keyword">case</span> CounterEvent.increment:
        <span class="keyword">yield</span> currentState + <span class="number">1</span>;
        <span class="keyword">break</span>;
    }
  }
</code></pre>
<p>ç°åœ¨ï¼Œæ¯å½“æˆ‘ä»¬è°ƒåº¦CounterEventæ—¶ï¼Œæˆ‘ä»¬çš„Blocå°†ä»¥æ–°çš„æ•´æ•°çŠ¶æ€å“åº”ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ä¸€ä¸ªè½¬æ¢è®°å½•è¢«æ‰“å°åˆ°åˆ°æ§åˆ¶å°ã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨Flutteræ„å»ºä¸€ä¸ªUIï¼Œå¹¶ä½¿ç”¨<a href="https://pub.dartlang.org/packages/flutter_bloc">flutter_bloc</a>åŒ…å°†è¡¨ç¤ºå±‚è¿æ¥åˆ°æˆ‘ä»¬çš„<code>CounterBloc</code>ã€‚</p>
<p><a href="https://pub.dartlang.org/packages/flutter_bloc">flutter_bloc</a>åŒ…æä¾›äº†ä¸¤ä¸ªwidgetï¼Œä½¿å¾—å¯ä»¥è½»æ¾åœ°ä¸Blocè¿›è¡Œäº¤äº’ï¼š</p>
<h2 id="BlocBuilder"><a href="#BlocBuilder" class="headerlink" title="BlocBuilder"></a>BlocBuilder</h2><p><code>BlocBuilder</code>æ˜¯ä¸€ä¸ªFlutter widgetï¼Œå®ƒéœ€è¦ä¸€ä¸ªBlocå’Œä¸€ä¸ªbuilderæ–¹æ³•ã€‚ BlocBuilderå¤„ç†äº†æ„å»ºwidgetçš„å·¥ä½œä»¥å“åº”æ–°çŠ¶æ€ã€‚BlocBuilderä¸StreamBuilderéå¸¸ç›¸ä¼¼ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªæ›´ç®€å•çš„APIæ¥å‡å°‘æ‰€éœ€çš„æ ·æ¿ä»£ç é‡ã€‚</p>
<h2 id="BlocProvider"><a href="#BlocProvider" class="headerlink" title="BlocProvider"></a>BlocProvider</h2><p><code>BlocProvider</code>æ˜¯ä¸€ä¸ªFlutter widgetï¼Œå®ƒé€šè¿‡<code>BlocProvider.of(context)</code>ä¸ºå…¶å­èŠ‚ç‚¹æä¾›ä¸€ä¸ªé›†åˆã€‚å®ƒè¢«ç”¨ä½œä¾èµ–æ³¨å…¥(DI)widgetï¼Œä»¥ä¾¿å¯ä»¥å°†BloCçš„å•ä¾‹æä¾›ç»™å­æ ‘ä¸­çš„å¤šä¸ªwidgetã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬æ„å»ºæˆ‘ä»¬çš„Counter Appï¼</p>
<pre><code class="dart">
<span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>{
  <span class="meta">@override</span>
  State&lt;StatefulWidget&gt; createState() =&gt; _AppState();
}

<span class="class"><span class="keyword">class</span> <span class="title">_AppState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">App</span>&gt; </span>{
  <span class="keyword">final</span> CounterBloc _counterBloc = CounterBloc();

  <span class="meta">@override</span>
  Widget build(BuildContext context) {
    <span class="keyword">return</span> MaterialApp(
      title: <span class="string">'Flutter Demo'</span>,
      home: BlocProvider&lt;CounterBloc&gt;(
        bloc: _counterBloc,
        child: CounterPage(),
      ),
    );
  }

  <span class="meta">@override</span>
  <span class="keyword">void</span> dispose() {
    _counterBloc.dispose();
    <span class="keyword">super</span>.dispose();
  }
}

<span class="class"><span class="keyword">class</span> <span class="title">CounterPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>{
  <span class="meta">@override</span>
  Widget build(BuildContext context) {
    <span class="keyword">final</span> CounterBloc _counterBloc = BlocProvider.of&lt;CounterBloc&gt;(context);

    <span class="keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="string">'Counter'</span>)),
      body: BlocBuilder&lt;CounterEvent, <span class="built_in">int</span>&gt;(
        bloc: _counterBloc,
        builder: (BuildContext context, <span class="built_in">int</span> count) {
          <span class="keyword">return</span> Center(
            child: Text(
              <span class="string">'<span class="subst">$count</span>'</span>,
              style: TextStyle(fontSize: <span class="number">24.0</span>),
            ),
          );
        },
      ),
      floatingActionButton: Column(
        crossAxisAlignment: CrossAxisAlignment.end,
        mainAxisAlignment: MainAxisAlignment.end,
        children: &lt;Widget&gt;[
          Padding(
            padding: EdgeInsets.symmetric(vertical: <span class="number">5.0</span>),
            child: FloatingActionButton(
              child: Icon(Icons.add),
              onPressed: () {
                _counterBloc.dispatch(CounterEvent.increment);
              },
            ),
          ),
          Padding(
            padding: EdgeInsets.symmetric(vertical: <span class="number">5.0</span>),
            child: FloatingActionButton(
              child: Icon(Icons.remove),
              onPressed: () {
                _counterBloc.dispatch(CounterEvent.decrement);
              },
            ),
          ),
        ],
      ),
    );
  }
}</code></pre>
<p>æˆ‘ä»¬çš„App widgetæ˜¯<code>StatefulWidget</code>ï¼Œè´Ÿè´£åˆ›å»ºå’Œå¤„ç†CounterBlocã€‚å®ƒä½¿ç”¨æˆ‘ä»¬ä¸Šé¢æåˆ°çš„BlocProvider widgetä½¿CounterBlocå¯ç”¨äºCounterPage widgetã€‚</p>
<p>æˆ‘ä»¬çš„<code>CounterPage</code> widgetæ˜¯ä¸€ä¸ª<code>StatelessWidget</code>ï¼Œå®ƒä½¿ç”¨<code>BlocBuilder</code>é‡å»ºUIä»¥å“åº”<code>CounterBloc</code>çš„çŠ¶æ€å˜åŒ–ã€‚</p>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ°å°†æˆ‘ä»¬çš„è¡¨ç¤ºå±‚ä¸ä¸šåŠ¡é€»è¾‘å±‚åˆ†å¼€ã€‚è¯·æ³¨æ„ï¼ŒCounterPage widget ä¸çŸ¥é“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚widgetåªæ˜¯å‘Šè¯‰CounterBlocç”¨æˆ·æŒ‰ä¸‹äº†é€’å¢æˆ–é€’å‡æŒ‰é’®ã€‚</p>
<p>å°±è¿™ä¹ˆå¤šã€‚</p>
<p>æœ‰å…³æ›´å¤šç¤ºä¾‹å’Œè¯¦ç»†æ–‡æ¡£ï¼Œè¯·æŸ¥çœ‹<a href="https://felangel.github.io/bloc">å®˜æ–¹blocæ–‡æ¡£</a>ã€‚</p>
<p>å¦‚æœä½ å–œæ¬¢è¿™ä¸ªblocåº“ï¼Œä½ å¯ä»¥é€šè¿‡â­ï¸<a href="https://github.com/felangel/bloc">ä»“åº“</a>æˆ–è€…ğŸ‘æ¥æ”¯æŒæˆ‘è¿™ä¸ªæ–‡ç« ã€‚</p>
